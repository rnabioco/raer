---
title: Introducing the raer package
author: 
  - name: Kent Riemondy
    affiliation: University of Colorado School of Medicine
  - name: Kristen Wells-Wrasman
    affiliation: University of Colorado School of Medicine
date: '`r Sys.Date()`'
output:
  BiocStyle::html_document
package: raer 
bibliography: ref.bib  
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}    
---

```{r, echo=FALSE, results="hide"}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Differential Editing tutorial

This vignette will demonstrate how to identify RNA editing sites with condition-specific editing frequencies using the `raer` package.

## Set up

```{r}
library(raer)
library(SummarizedExperiment)
library(DESeq2)
library(ComplexHeatmap)
library(viridis)
library(rtracklayer)
```


In this vignette a public RNA-seq dataset will be analyzed,  [GSE99249](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE99249), which consists of ADAR1 mutants and control human cell lines, conditionally treated with Interferon-Beta. For simplicity we will examine the ADAR1 WT and KO samples both treated with IFN-B, with triplicate samples. 

Aligned BAM files and other necessary files have been preprocessed for this vignette. These files occupy ~250 Mb of space and they are stored in a `BiocFileCache`.

```{r}
fns <- download_GSE99249()
```

Next we'll collect a vector containing the paths to each BAM file These BAM files are a subset of the full BAM files, containing only alignments from chromosome 18.

```{r}
bam_files <- fns$bams
names(bam_files) <- sub("_dedup_sorted.bam", "", basename(bam_files))
bam_files[1:2]
```

Next we'll need a FASTA file to quantify the editing sites. We'll use a FASTA file only containing chromosome 18 for this demo. The fasta can be compressed. 

```{r}
fafn <- fns$fasta
fafn
```

Lastly, we'll use a BED file containing the coordinates of known human editing sites from the REDIPortal database. This file can also be optionally compressed.

```{r}
sites <- import(fns$bed)
sites
```

## Generate editing site read counts 

The `pileup_sites()` function will calculate base counts across multiple BAM files. The base counts will be returned as a list of `GRanges` objects for each bam file. The `FilterParam()` function provides numerous filters to exclude reads and bases based on commonly used filters for detecting RNA-editing events. Specific regions can be queried using the `region` argument, or specific positions can be queried by providing `bedfile` a path to a BED-file. 

Internally, `pileup_sites()` will generate pileups in memory. However, these files can also be stored in a tabix-indexed format, for later retrieval, or for querying specific regions.

```{r}
fp <- FilterParam(
    only_keep_variants = TRUE,
    trim_5p = 5,
    trim_3p = 5,
    min_base_quality = 30L,
    min_mapq = 255L,
    library_type = "fr-first-strand",
    min_splice_overhang = 10
)

rse <- pileup_sites(bam_files,
    fafile = fafn,
    sites = sites,
    region = "chr18",
    param = fp
)
```


Pileups data is stored in a `summarizedExperiment` object, which permits comparisons across each sample. The `rowData()` and `rowRanges()` slots can be populated with information related to each editing site, and similarly the `colData()` slot can be used to store sample metadata. The summarizedExperiment object can also interface with other derivative classes, such as `singleCellExperiment()`. 


The base counts are counted in a stand specific fashion depending on the `library-type` parameter. The `REF` and `ALT` bases are in reference to the strand. 

```{r}
rse
```

Next we will add sample metadata to the `summarizedExperiment`, which will be used to conduct differential editing analysis. 

```{r}
colData(rse)$genotype_treatment <- rep(
    c(
        "ADAR1KO Interferon beta",
        "Wildtype Interferon beta"
    ),
    each = 3
)

colData(rse)$genotype <- rep(
    c(
        "ADAR1KO",
        "Wildtype"
    ),
    each = 3
)
colData(rse)
```

## Prepare for differential editing 

We next use the `calc_edit_frequency` function to identify the percent of edits for each position and sample. With the `drop = TRUE` argument we will also exclude sites without an adenosine. The editing frequencies will not be used for differential editing analysis, which will be conducted using the raw counts, however these are useful for filtering and visualization. 


```{r}
se_filtered <- calc_edit_frequency(rse,
    edit_from = "A",
    edit_to = "G",
    drop = TRUE
)
```

We can next subset the `summarizedExperiment` object to exclude low frequency editing events. For this analysis we will require that an editing site shows editing in at least 1 sample, and have at least 5 counts in each sample. 

```{r}
has_editing <- rowSums(assay(se_filtered, "edit_freq") > 0) >= 1
has_depth <- rowSums(((assay(se_filtered, "nRef") +
    assay(se_filtered, "nAlt")) >= 5)) == ncol(se_filtered)

se_filtered <- se_filtered[has_editing & has_depth, ]
se_filtered
```

Once the object has been filtered, you can prepare it for DE. This means making a new object that contains an assay with read counts if both the alt and ref alleles in a single matrix.

```{r}
deobj <- prep_for_de(se_filtered,
    min_prop = 0.1,
    max_prop = 0.9,
    min_samples = 3
)

assay(deobj, "counts")[1:3, 1:6]
```

## Run differential editing (DESeq2)

At this stage, you can use the object to perform DE yourself or you can continue with our pre built functions

For differential editing, we use the design `design <- ~0 + condition:sample + condition:count`.

For the samples, you can leave as is or combine so the same sample name shows up in both the treatment and control. These results are not identical but they are close. In my hands, the same genes come out, but the p values and log fold change values are slightly different.

It is probably best to update the levels of your object, but if you don't, this will still work.


```{r}
de_results <- perform_de(deobj,
    sample_col = "sample",
    condition_col = "genotype",
    condition_control = "Wildtype",
    condition_treatment = "ADAR1KO"
)
```

This returns a list containing the dds object, the full results, the significant results, and the model matrix. 

```{r}
de_results$sig_results[1:5, ]
```

```{r, fig.height=7, fig.width=5}
top_sites <- rownames(de_results$sig_results)[1:20]

Heatmap(assay(se_filtered, "edit_freq")[top_sites, ], 
        name = "editing frequency",
        col = viridis(100),
        column_labels = se_filtered$genotype_treatment
)
```


## Examine overall editing activites using the Alu Editing Index

For some studies it may be informative to assess the overall ADAR editing activity rather
than examining individual editing sites. The **Alu Editing Index** (AEI), developed 
by @Roth2019-yu, is a metric that summarizes that amount of editing occurring 
at ALU elements which account for the vast majority of A-to-I editing (> 99%) in humans.

`raer` provides `calc_AEI()` to calculate the AEI metric. Many of the same parameters used 
for `pileup_sites()` are available in `calc_AEI()`. 

First we will use the `AnnotationHub` to obtain coordinates for ALU elements. Then we will use a `SNPlocs` package to identify SNPs overlapping the ALU elements from the dbSNP database, which will be excluded from the AEI calculation. The SNPlocs coordinates are `NCBI` based, whereas the `ALU` elements are based on `hg38`, we will therefore convert between the two as needed to obtain SNP and ALU element coordinates based on `hg38`. 



```{r}
library(AnnotationHub)
library(SNPlocs.Hsapiens.dbSNP144.GRCh38)

ah <- AnnotationHub()
rmsk_hg38 <- ah[["AH99003"]]

alus <- rmsk_hg38[rmsk_hg38$repFamily == "Alu" & seqnames(rmsk_hg38) == "chr18", ]
alus <- keepStandardChromosomes(alus) 
seqlevelsStyle(alus) <- "NCBI"
genome(alus) <- "GRCh38.p2"

alu_snps <- get_overlapping_snps(alus, SNPlocs.Hsapiens.dbSNP144.GRCh38)

seqlevelsStyle(alu_snps) <- "UCSC"
alu_snps[1:3, ]

seqlevelsStyle(alus) <- "UCSC"
alus[1:3, ]
```

`calc_AEI()` will return a matrix containing the AEI calculated for all allelic combinations and a more detailed table containing values for each chromosome.

```{r}
alu_index <- calc_AEI(bam_fn = bam_files, 
                      fasta_fn = fafn, 
                      snp_db = alu_snps,
                      alu_ranges = alus, 
                      param = fp)
names(alu_index)
```

The AEI in wild-type samples is highest for `A-to-G`, as expected, and sharply 
reduced in the `ADAR1KO` samples. 

```{r}
Heatmap(alu_index$AEI, 
        name = "AEI",
        col = viridis(100), 
        row_labels = rse$genotype_treatment[match(rownames(alu_index$AEI),
                                                  rse$sample)]
)
```

<details style="margin-bottom:10px;">
<summary>
    Session info
</summary>

```{r}
sessionInfo()
```

</details>


